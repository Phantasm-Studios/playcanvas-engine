<!DOCTYPE html>
<html>
<head>
    <title>PlayCanvas Shadow Cascades</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="icon" type="image/png" href="../playcanvas-favicon.png" />
    <script src="../../build/playcanvas.js"></script>
    <script src="../../build/playcanvas-extras.js"></script>
    <style>
        body { 
            margin: 0;
            overflow-y: hidden;
        }
    </style>
</head>

<body>
    <!-- The canvas element -->
    <canvas id="application-canvas"></canvas>

    <!-- The script -->
    <script>
        var canvas = document.getElementById("application-canvas");

        // Create the application and start the update loop
        var app = new pc.Application(canvas, {
            mouse: new pc.Mouse(canvas),
            keyboard: new pc.Keyboard(window)
        });

        app.start();

        // Set the canvas to fill the window and automatically change resolution to be the same as the canvas size
        app.setCanvasFillMode(pc.FILLMODE_FILL_WINDOW);
        app.setCanvasResolution(pc.RESOLUTION_AUTO);

        window.addEventListener("resize", function () {
            app.resizeCanvas(canvas.width, canvas.height);
        });

        var miniStats = new pcx.MiniStats(app);

        app.scene.ambientLight = new pc.Color(0.5, 0.5, 0.5);

        function createPrimitive(primitiveType, position, scale, color) {

            // create a material
            var material = new pc.StandardMaterial();

            if (primitiveType === "capsule") {
                material.diffuse = new pc.Color(Math.random(), Math.random(), Math.random());
                material.shininess = 70;
                material.metalness = 0.4;
                material.useMetalness = true;
            }
            material.update();

            // create the primitive using the material
            var primitive = new pc.Entity();
            primitive.addComponent('render', {
                type: primitiveType,
                material: material
            });                    

            // set position and scale and add it to scene
            primitive.setLocalPosition(position);
            primitive.setLocalScale(scale);
            app.root.addChild(primitive);
        }

        // create ground plane
        var limit = 200;
        createPrimitive("plane", new pc.Vec3(0, 0, 0), new pc.Vec3(3 * limit, 3 * limit, 3 * limit), new pc.Color(1, 1, 1));

        // populate it with capsules
        for (var x = -limit; x <= limit; x += 50) {
            for (var z = -limit; z <= limit; z += 50) {
                createPrimitive("capsule", new pc.Vec3(x, 15, z), new pc.Vec3(12, 22, 12), new pc.Color(1.2, 0.3, 0.1));
            }
        }

        // create an Entity with a camera component
        var camera = new pc.Entity();
        camera.addComponent("camera", {
            clearColor: new pc.Color(0.9, 0.9, 0.9),
            farClip: 1000
        });
        app.root.addChild(camera);

        // and position it in the world
        camera.setLocalPosition(20, 80, 250);
        camera.lookAt(-30, -50, 0);

        // add the fly camera script to the camera, to allow mouse / keyboard movement
        app.assets.loadFromUrl('../../scripts/camera/fly-camera.js', 'script', function (err, asset) {
            camera.addComponent("script");
            camera.script.create("flyCamera");
            camera.script.flyCamera.speed = 60;
        });

        // Create a directional light casting cascaded shadows
        var dirLight = new pc.Entity();
        dirLight.addComponent("light", {
            type: "directional",
            color: pc.Color.WHITE,
            shadowBias: 0.3,
            normalOffsetBias: 0.2,
            intensity: 1.0,

            // enable shadow casting 
            castShadows: true,
            shadowDistance: 1000,

            // shadow map resolution storing 4 cascades
            shadowResolution: 2048,
            numCascades : 4,

            // distribution of cascade distances to prefer sharpness closer to the camera
            cascadeDistribution: 0.7,

            // shadow filtering
            shadowType: pc.SHADOW_PCF3
        });
        app.root.addChild(dirLight);
        dirLight.setLocalEulerAngles(45, -20, 20);

    </script>
</body>
</html>
